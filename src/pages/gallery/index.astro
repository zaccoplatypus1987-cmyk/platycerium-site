---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
---

<BaseLayout title="ã‚®ãƒ£ãƒ©ãƒªãƒ¼ï¼ˆå¤§åˆ†é¡ï¼‰ - Platycerium Collection">
    <!-- Custom CSS -->
    <style is:global>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* ã™ã¹ã¦ã®ä½™ç™½ã‚’å®Œå…¨ã«å‰Šé™¤ */
        header {
            margin: 0 !important;
            display: block !important;
        }

        header > div {
            padding-bottom: 0 !important;
        }

        section.mosaic-hero {
            margin: 0 !important;
            padding: 0 !important;
            display: block !important;
            position: relative;
            top: -1px;
        }

        main {
            margin-top: 0 !important;
            padding-top: 2rem;
        }

        * {
            box-sizing: border-box;
        }

        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .species-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            height: 480px;
        }

        .species-card > div:first-child {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .species-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }

        .species-thumbnail {
            width: 100%;
            height: 280px;
            object-fit: cover;
            object-position: center center;
            display: block;
        }

        .species-card-content {
            height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }

        .species-card-footer {
            height: 60px;
            display: flex;
            align-items: center;
        }

        .badge-pure {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .badge-hybrid {
            background-color: #fff3e0;
            color: #ef6c00;
        }

        .filter-active {
            background-color: #4A7C2F !important;
            color: white !important;
        }

        .accordion-header {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .accordion-header:hover {
            background-color: #f3f4f6;
        }

        .accordion-icon {
            transition: transform 0.3s ease;
        }

        .accordion-icon.rotate {
            transform: rotate(180deg);
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .accordion-content.open {
            max-height: 4000px;
        }

        .filter-item {
            transition: all 0.2s ease;
        }

        .filter-item.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
        }

        .subspecies-item {
            padding-left: 1rem;
            border-left: 2px solid #e5e7eb;
            font-size: 0.875rem;
        }

        .month-item {
            padding-left: 1rem;
            font-size: 0.875rem;
        }

        /* ãƒ¢ã‚¶ã‚¤ã‚¯ãƒ’ãƒ¼ãƒ­ãƒ¼ */
        .mosaic-hero {
            position: relative;
            width: 100%;
            min-height: 70vh;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 0;
        }

        .mosaic-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 0;
            margin: 0;
            padding: 0;
            line-height: 0;
            opacity: 0.4;
        }

        .mosaic-tile {
            position: relative;
            aspect-ratio: 1;
            overflow: hidden;
            cursor: pointer;
            transition: opacity 0.3s ease, transform 0.2s ease;
            margin: 0;
            padding: 0;
            border: none;
            line-height: 0;
        }

        .mosaic-tile:hover {
            opacity: 1;
            transform: scale(1.1);
            z-index: 10;
        }

        .mosaic-tile img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            margin: 0;
            padding: 0;
            border: none;
            vertical-align: top;
        }

        .mosaic-tile-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9), transparent);
            padding: 6px 4px 4px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .mosaic-tile:hover .mosaic-tile-overlay {
            opacity: 1;
        }

        .mosaic-tile-name {
            color: white;
            font-size: 0.65rem;
            font-weight: 600;
            line-height: 1.1;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .hero-title-overlay {
            position: relative;
            z-index: 20;
            text-align: center;
            padding: 2rem;
        }

        .hero-title {
            font-size: 5rem;
            font-weight: 900;
            color: white;
            text-shadow: 0 4px 12px rgba(0, 0, 0, 0.8);
            margin-bottom: 1rem;
            letter-spacing: -0.02em;
        }

        .hero-subtitle {
            font-size: 1.5rem;
            color: white;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.8);
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .mosaic-grid {
                grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            }

            .hero-title {
                font-size: 3rem;
            }

            .hero-subtitle {
                font-size: 1.2rem;
            }

            .mosaic-hero {
                min-height: 60vh;
            }
        }

        @media (max-width: 1024px) {
            aside {
                position: static !important;
            }
        }
    </style>

<Header />

<!-- Mosaic Hero Section -->
<section class="mosaic-hero">
    <div id="mosaic-gallery" class="mosaic-grid">
        <!-- ãƒ¢ã‚¶ã‚¤ã‚¯ã‚¿ã‚¤ãƒ«ãŒã“ã“ã«å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
    </div>
    <div class="hero-title-overlay">
        <h1 class="hero-title">ã‚®ãƒ£ãƒ©ãƒªãƒ¼</h1>
        <p class="hero-subtitle" id="gallery-stats">å…¨76å“ç¨® / 1,768ä»¶ã®æŠ•ç¨¿</p>
    </div>
</section>

<main class="container mx-auto px-4">
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Sidebar Filters -->
            <aside class="lg:w-80 flex-shrink-0">
                <div class="bg-white rounded-lg shadow-md p-6 lg:sticky lg:top-24">
                    <h2 class="text-xl font-bold mb-4">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h2>

                    <!-- Species Filter (2-level accordion) -->
                    <div class="mb-6">
                        <div class="accordion-header flex items-center justify-between p-2 rounded"
                             onclick="toggleAccordion('species-accordion')">
                            <h3 class="font-semibold">åŸç¨®</h3>
                            <svg class="accordion-icon w-5 h-5 text-gray-600 rotate" id="species-accordion-icon"
                                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                        <div class="accordion-content open mt-2" id="species-accordion">
                            <!-- Will be dynamically generated -->
                        </div>
                    </div>

                    <!-- Post Date Filter (3-level accordion) -->
                    <div class="mb-6">
                        <div class="accordion-header flex items-center justify-between p-2 rounded"
                             onclick="toggleAccordion('date-accordion')">
                            <h3 class="font-semibold">æŠ•ç¨¿æ™‚æœŸ</h3>
                            <svg class="accordion-icon w-5 h-5 text-gray-600 rotate" id="date-accordion-icon"
                                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                        <div class="accordion-content open mt-2" id="date-accordion">
                            <!-- Will be dynamically generated -->
                        </div>
                    </div>

                    <!-- Clear Button -->
                    <button id="clear-filters" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded transition-colors">
                        ã™ã¹ã¦ã‚¯ãƒªã‚¢
                    </button>
                </div>
            </aside>

            <!-- Main Content -->
            <div class="flex-1">
                <!-- Loading Indicator -->
                <div id="loading" class="text-center py-12">
                    <div class="inline-flex items-center gap-2 text-gray-600">
                        <svg class="animate-spin h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="text-lg">å“ç¨®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</span>
                    </div>
                </div>

                <!-- Error Message -->
                <div id="error" class="hidden text-center py-12">
                    <p class="text-xl text-red-600 mb-4"></p>
                    <button onclick="location.reload()" class="bg-forest-mid hover:bg-forest-dark text-white font-semibold py-2 px-6 rounded-lg transition-colors">
                        å†èª­ã¿è¾¼ã¿
                    </button>
                </div>

                <!-- Pure Species Section -->
                <div id="pure-species-section" class="hidden mb-12">
                    <div class="mb-6">
                        <h3 class="text-2xl font-bold text-forest-dark mb-2">
                            ğŸŒ± åŸç¨®18ç¨®ï¼ˆPure Speciesï¼‰
                        </h3>
                        <p class="text-gray-600">
                            è‡ªç„¶ç•Œã«å­˜åœ¨ã™ã‚‹ãƒ“ã‚«ã‚¯ã‚·ãƒ€ã®åŸç¨®ã€‚ãã‚Œãã‚Œç‹¬è‡ªã®ç‰¹å¾´ã‚’æŒã£ã¦ã„ã¾ã™ã€‚
                        </p>
                    </div>
                    <div id="pure-species-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        <!-- Pure species cards will be rendered here -->
                    </div>
                </div>

                <!-- Hybrid Species Section -->
                <div id="hybrid-species-section" class="hidden">
                    <div class="mb-6">
                        <h3 class="text-2xl font-bold text-forest-dark mb-2">
                            ğŸ§¬ äº¤é…ç¨®ãƒ»äº¤é›‘ç¨®ï¼ˆHybridsï¼‰
                        </h3>
                        <p class="text-gray-600">
                            åŸç¨®åŒå£«ã®äº¤é…ã‚„å“ç¨®æ”¹è‰¯ã«ã‚ˆã£ã¦ç”Ÿã¾ã‚ŒãŸå“ç¨®ã€‚å€‹æ€§è±Šã‹ãªé­…åŠ›ãŒã‚ã‚Šã¾ã™ã€‚
                        </p>
                    </div>
                    <div id="hybrid-species-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        <!-- Hybrid species cards will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
</main>

<Footer />

    <!-- JavaScript -->
    <script is:inline type="module">
        // åŸç¨®åãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆè‹±èªè¡¨è¨˜ï¼‰
        const speciesNameMap = {
            'bifurcatum': 'P. bifurcatum',
            'willinckii': 'P. willinckii',
            'coronarium': 'P. coronarium',
            'ridleyi': 'P. ridleyi',
            'wandae': 'P. wandae',
            'superbum': 'P. superbum',
            'veitchii': 'P. veitchii',
            'hillii': 'P. hillii',
            'alcicorne': 'P. alcicorne',
            'elephantotis': 'P. elephantotis',
            'ellisii': 'P. ellisii',
            'holttumii': 'P. holttumii',
            'stemaria': 'P. stemaria',
            'andinum': 'P. andinum',
            'quadridichotomum': 'P. quadridichotomum',
            'grande': 'P. grande',
            'wallichii': 'P. wallichii',
            'madagascariense': 'P. madagascariense',
            'hybrid': 'äº¤é…ç¨® (Hybrids)'
        };

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹
        let allSpeciesData = [];
        let allSubspeciesData = {}; // å“ç¨®IDã”ã¨ã®æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿
        let currentFilters = {
            species: 'all',      // åŸç¨®ID or 'all'
            subspecies: 'all',   // åœ’èŠ¸å“ç¨®ID or 'all'
            year: 'all',         // å¹´ or 'all'
            month: 'all'         // æœˆ or 'all'
        };
        let searchQuery = '';

        // ãƒ¢ã‚¶ã‚¤ã‚¯ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‚’ç”Ÿæˆ
        function renderMosaicGallery(allSpecies) {
            const mosaicContainer = document.getElementById('mosaic-gallery');
            if (!mosaicContainer) return;

            // å…¨å“ç¨®ã‚’1ã¤ã®é…åˆ—ã«çµ±åˆ
            let allTiles = [];

            allSpecies.forEach(item => {
                // åŸç¨®ã®å ´åˆã¯åœ’èŠ¸å“ç¨®ã‚’å±•é–‹
                if (item.type === 'pure' && item.subSpecies && item.subSpecies.length > 0) {
                    item.subSpecies.forEach(sub => {
                        allTiles.push({
                            id: sub.id,
                            name: sub.displayName || sub.name,
                            image: sub.latestImage,
                            type: 'subspecies'
                        });
                    });
                } else {
                    // äº¤é…ç¨®ã¾ãŸã¯åœ’èŠ¸å“ç¨®ãªã—åŸç¨®
                    allTiles.push({
                        id: item.id,
                        name: item.displayName || item.name || speciesNameMap[item.id],
                        image: item.latestImage,
                        type: item.type
                    });
                }
            });

            // ãƒ¢ã‚¶ã‚¤ã‚¯ã‚¿ã‚¤ãƒ«ã‚’ç”Ÿæˆ
            const tilesHTML = allTiles.map(tile => {
                const imageSrc = tile.image ? `/${tile.image}` : '/images/placeholder-leaf.svg';
                const linkUrl = `/gallery/detail?id=${tile.id}`;

                return `
                    <div class="mosaic-tile" onclick="window.location.href='${linkUrl}'">
                        <img src="${imageSrc}"
                             alt="${tile.name}"
                             loading="lazy"
                             onerror="this.src='/images/placeholder-leaf.svg'">
                        <div class="mosaic-tile-overlay">
                            <div class="mosaic-tile-name">${tile.name}</div>
                        </div>
                    </div>
                `;
            }).join('');

            mosaicContainer.innerHTML = tilesHTML;
        }

        // éšå±¤æ§‹é€ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹èª­ã¿è¾¼ã¿
        async function loadMainSpecies() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const stats = document.getElementById('gallery-stats');
            const pureSection = document.getElementById('pure-species-section');
            const hybridSection = document.getElementById('hybrid-species-section');
            const pureGrid = document.getElementById('pure-species-grid');
            const hybridGrid = document.getElementById('hybrid-species-grid');

            try {
                const response = await fetch('/data/species-hierarchy-index.json');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                console.log('Loaded data:', data);

                // hierarchyé…åˆ—ã‹ã‚‰åŸç¨®ã¨äº¤é…ç¨®ã‚’åˆ†é›¢
                const hierarchyData = data.hierarchy || [];
                allSpeciesData = hierarchyData;

                // ãƒ¢ã‚¶ã‚¤ã‚¯ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‚’ç”Ÿæˆ
                renderMosaicGallery(hierarchyData);

                // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’æ§‹ç¯‰
                buildSpeciesFilter(hierarchyData);
                buildDateFilter(data.species || []);

                // æ¤œç´¢æ©Ÿèƒ½ã‚’è¨­å®š
                setupSearch();

                // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®è¨­å®š
                const clearBtn = document.getElementById('clear-filters');
                if (clearBtn) {
                    clearBtn.addEventListener('click', () => {
                        clearFilters();
                    });
                }

                // åˆæœŸè¡¨ç¤º
                applyFilters();

                loading.classList.add('hidden');

            } catch (err) {
                console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
                loading.classList.add('hidden');
                error.classList.remove('hidden');
                error.querySelector('p').textContent = `ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.message}`;
            }
        }

        // åŸç¨®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’æ§‹ç¯‰ï¼ˆ2éšå±¤ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼‰
        function buildSpeciesFilter(hierarchyData) {
            const container = document.getElementById('species-accordion');
            if (!container) return;

            // æŠ•ç¨¿ãŒã‚ã‚‹åŸç¨®ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆç´”ç²‹ãªåŸç¨®ã®ã¿ã€äº¤é…ç¨®ã¯é™¤å¤–ï¼‰
            const pureSpecies = hierarchyData.filter(item =>
                item.type === 'pure' && item.totalPosts > 0
            );

            let html = `
                <button class="filter-item w-full text-left px-3 py-2 rounded hover:bg-gray-100 transition-colors filter-active mb-1"
                        data-filter-type="species" data-filter-value="all"
                        onclick="selectSpecies('all', event)">
                    ã™ã¹ã¦
                </button>
            `;

            // å„åŸç¨®ã¨ãã®åœ’èŠ¸å“ç¨®
            pureSpecies.forEach(species => {
                const speciesKey = species.id;
                const speciesName = speciesNameMap[speciesKey] || `P. ${speciesKey}`;
                const accordionId = `subspecies-${speciesKey}`;

                html += `
                    <div class="mb-1">
                        <div class="flex items-center">
                            <button class="filter-item flex-1 text-left px-3 py-2 rounded hover:bg-gray-100 transition-colors"
                                    data-filter-type="species" data-filter-value="${speciesKey}"
                                    onclick="selectSpecies('${speciesKey}', event)">
                                ${speciesName}
                            </button>
                            <button class="p-2 hover:bg-gray-100 rounded"
                                    onclick="toggleSubAccordion('${accordionId}', event)">
                                <svg class="w-4 h-4 text-gray-600 accordion-icon" id="${accordionId}-icon"
                                     fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="accordion-content mt-1" id="${accordionId}" style="max-height: 0;">
                `;

                // åœ’èŠ¸å“ç¨®ãƒªã‚¹ãƒˆï¼ˆäº¤é…ç¨®ã‚’é™¤å¤–ï¼‰
                if (species.subSpecies && species.subSpecies.length > 0) {
                    // äº¤é…ç¨®ï¼ˆdisplayNameã«Ã—ãŒå«ã¾ã‚Œã‚‹ã€ã¾ãŸã¯mainSpeciesãŒhybridï¼‰ã‚’é™¤å¤–
                    const pureSubspecies = species.subSpecies.filter(sub => {
                        const hasHybridMarker = sub.displayName && sub.displayName.includes('Ã—');
                        return !hasHybridMarker;
                    });

                    pureSubspecies.forEach(sub => {
                        html += `
                            <button class="filter-item subspecies-item w-full text-left px-3 py-1 rounded hover:bg-gray-100 transition-colors text-sm"
                                    data-filter-type="subspecies" data-filter-value="${sub.id}"
                                    onclick="selectSubspecies('${sub.id}', event)">
                                ${sub.displayName}
                            </button>
                        `;
                    });
                }

                html += `
                        </div>
                    </div>
                `;
            });

            // äº¤é…ç¨®ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆã‚µãƒ–ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ä»˜ãï¼‰
            const hybridSpecies = hierarchyData.filter(item => item.type === 'hybrid' && item.totalPosts > 0);
            const hybridAccordionId = 'subspecies-hybrid';

            html += `
                <div class="mb-1">
                    <div class="flex items-center">
                        <button class="filter-item flex-1 text-left px-3 py-2 rounded hover:bg-gray-100 transition-colors"
                                data-filter-type="species" data-filter-value="hybrid"
                                onclick="selectSpecies('hybrid', event)">
                            äº¤é…ç¨®
                        </button>
                        <button class="p-2 hover:bg-gray-100 rounded"
                                onclick="toggleSubAccordion('${hybridAccordionId}', event)">
                            <svg class="w-4 h-4 text-gray-600 accordion-icon" id="${hybridAccordionId}-icon"
                                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="accordion-content mt-1" id="${hybridAccordionId}" style="max-height: 0;">
            `;

            // äº¤é…ç¨®ãƒªã‚¹ãƒˆ
            hybridSpecies.forEach(hybrid => {
                html += `
                    <button class="filter-item subspecies-item w-full text-left px-3 py-1 rounded hover:bg-gray-100 transition-colors text-sm"
                            data-filter-type="subspecies" data-filter-value="${hybrid.id}"
                            onclick="selectSubspecies('${hybrid.id}', event)">
                        ${hybrid.name || hybrid.displayName || hybrid.id}
                    </button>
                `;
            });

            html += `
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        // æŠ•ç¨¿æ™‚æœŸãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’æ§‹ç¯‰ï¼ˆ3éšå±¤ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼‰
        async function buildDateFilter(allSpeciesList) {
            const container = document.getElementById('date-accordion');
            if (!container) return;

            // ã™ã¹ã¦ã®å“ç¨®ã‹ã‚‰æŠ•ç¨¿æ—¥ä»˜ã‚’æŠ½å‡º
            const dateSet = new Set();

            // species é…åˆ—ï¼ˆå…¨76å“ç¨®ï¼‰ã‹ã‚‰ latestPostDate ã‚’æŠ½å‡º
            if (allSpeciesList && allSpeciesList.length > 0) {
                allSpeciesList.forEach(species => {
                    if (species.latestPostDate) {
                        const [year, month] = species.latestPostDate.split('-');
                        if (year && month) {
                            dateSet.add(`${year}-${month}`);
                        }
                    }
                });
            }

            console.log('Extracted dates:', Array.from(dateSet).sort());
            console.log('Total unique months:', dateSet.size);

            // å¹´æœˆã‚’ã‚½ãƒ¼ãƒˆ
            const sortedDates = Array.from(dateSet).sort().reverse();

            // å¹´ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const yearMap = {};
            sortedDates.forEach(dateStr => {
                const [year, month] = dateStr.split('-');
                if (!yearMap[year]) {
                    yearMap[year] = [];
                }
                yearMap[year].push(month);
            });

            let html = `
                <button class="filter-item w-full text-left px-3 py-2 rounded hover:bg-gray-100 transition-colors filter-active mb-1"
                        data-filter-type="date" data-filter-value="all"
                        onclick="selectDateAll(event)">
                    ã™ã¹ã¦
                </button>
            `;

            // å„å¹´ã¨ãã®æœˆ
            Object.keys(yearMap).sort().reverse().forEach(year => {
                const accordionId = `year-${year}`;

                html += `
                    <div class="mb-1">
                        <div class="flex items-center">
                            <button class="filter-item flex-1 text-left px-3 py-2 rounded hover:bg-gray-100 transition-colors"
                                    data-filter-type="year" data-filter-value="${year}"
                                    onclick="selectYear('${year}', event)">
                                ${year}å¹´
                            </button>
                            <button class="p-2 hover:bg-gray-100 rounded"
                                    onclick="toggleSubAccordion('${accordionId}', event)">
                                <svg class="w-4 h-4 text-gray-600 accordion-icon" id="${accordionId}-icon"
                                     fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="accordion-content mt-1" id="${accordionId}" style="max-height: 0;">
                `;

                // æœˆãƒªã‚¹ãƒˆ
                yearMap[year].sort().forEach(month => {
                    html += `
                        <button class="filter-item month-item w-full text-left px-3 py-1 rounded hover:bg-gray-100 transition-colors text-sm"
                                data-filter-type="month" data-filter-value="${year}-${month}"
                                onclick="selectMonth('${year}', '${month}', event)">
                            ${parseInt(month)}æœˆ
                        </button>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // æ¤œç´¢æ©Ÿèƒ½ã®è¨­å®š
        function setupSearch() {
            const searchInput = document.getElementById('search-input');
            if (!searchInput) return;

            let searchTimeout;
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    searchQuery = e.target.value.toLowerCase();
                    applyFilters();
                }, 300);
            });
        }

        // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³é–‹é–‰ï¼ˆã‚µãƒ–ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ç”¨ï¼‰
        window.toggleSubAccordion = function(accordionId, event) {
            event.stopPropagation();
            const content = document.getElementById(accordionId);
            const icon = document.getElementById(accordionId + '-icon');

            if (content && icon) {
                const isOpen = content.style.maxHeight && content.style.maxHeight !== '0px';
                content.style.maxHeight = isOpen ? '0' : '4000px';
                icon.classList.toggle('rotate');
            }
        }

        // åŸç¨®é¸æŠ
        window.selectSpecies = function(speciesKey, event) {
            event.stopPropagation();

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('[data-filter-type="species"]').forEach(btn => {
                btn.classList.remove('filter-active');
            });
            event.target.classList.add('filter-active');

            // åœ’èŠ¸å“ç¨®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‚¯ãƒªã‚¢
            currentFilters.species = speciesKey;
            currentFilters.subspecies = 'all';

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
            applyFilters();
        }

        // åœ’èŠ¸å“ç¨®é¸æŠï¼ˆæŠ•ç¨¿ãƒšãƒ¼ã‚¸ã«é·ç§»ï¼‰
        window.selectSubspecies = function(subspeciesId, event) {
            event.stopPropagation();

            // åœ’èŠ¸å“ç¨®ã®æŠ•ç¨¿ãƒšãƒ¼ã‚¸ã«é·ç§»
            window.location.href = `/gallery/detail?id=${subspeciesId}`;
        }

        // å¹´é¸æŠ
        window.selectYear = function(year, event) {
            event.stopPropagation();

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('[data-filter-type="year"], [data-filter-type="month"]').forEach(btn => {
                btn.classList.remove('filter-active');
            });
            event.target.classList.add('filter-active');

            currentFilters.year = year;
            currentFilters.month = 'all';

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
            applyFilters();
        }

        // æœˆé¸æŠ
        window.selectMonth = function(year, month, event) {
            event.stopPropagation();

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('[data-filter-type="year"], [data-filter-type="month"]').forEach(btn => {
                btn.classList.remove('filter-active');
            });
            event.target.classList.add('filter-active');

            currentFilters.year = year;
            currentFilters.month = month;

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
            applyFilters();
        }

        // æŠ•ç¨¿æ™‚æœŸã€Œã™ã¹ã¦ã€é¸æŠ
        window.selectDateAll = function(event) {
            event.stopPropagation();

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('[data-filter-type="date"], [data-filter-type="year"], [data-filter-type="month"]').forEach(btn => {
                btn.classList.remove('filter-active');
            });
            event.target.classList.add('filter-active');

            currentFilters.year = 'all';
            currentFilters.month = 'all';

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
            applyFilters();
        }

        // æŠ•ç¨¿æ™‚æœŸãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’å‹•çš„æ›´æ–°
        async function updateDateFilterAvailability(subspeciesId) {
            if (subspeciesId === 'all') {
                // ã™ã¹ã¦ã®æœˆã‚’æœ‰åŠ¹åŒ–
                document.querySelectorAll('[data-filter-type="month"]').forEach(btn => {
                    btn.classList.remove('disabled');
                });
                return;
            }

            try {
                // å“ç¨®ã®æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
                const response = await fetch(`/data/species/${subspeciesId}.json`);
                if (!response.ok) return;

                const data = await response.json();
                const posts = data.posts || [];

                // æŠ•ç¨¿ãŒã‚ã‚‹å¹´æœˆã‚’ã‚»ãƒƒãƒˆåŒ–
                const availableDates = new Set();
                posts.forEach(post => {
                    if (post.date) {
                        const [year, month] = post.date.split('-');
                        availableDates.add(`${year}-${month}`);
                    }
                });

                // æœˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
                document.querySelectorAll('[data-filter-type="month"]').forEach(btn => {
                    const dateValue = btn.dataset.filterValue;
                    if (availableDates.has(dateValue)) {
                        btn.classList.remove('disabled');
                    } else {
                        btn.classList.add('disabled');
                    }
                });

            } catch (error) {
                console.error('æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
        function applyFilters() {
            let filteredSpecies = [...allSpeciesData];
            let searchFilterActive = false;

            // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆæ”¹å–„ç‰ˆï¼‰
            if (searchQuery) {
                console.log('=== Search Query ===', searchQuery);
                searchFilterActive = true;

                filteredSpecies = filteredSpecies.map(species => {
                    // åŸç¨®åã§ã®æ¤œç´¢
                    const displayName = (species.displayName || species.name || species.id || '').toLowerCase();
                    const englishName = (speciesNameMap[species.id] || '').toLowerCase();
                    const parentMatches = displayName.includes(searchQuery) || englishName.includes(searchQuery);

                    console.log(`Checking species: ${species.id}, parentMatches: ${parentMatches}`);

                    // åœ’èŠ¸å“ç¨®åã§ã®æ¤œç´¢
                    let matchedSubspecies = [];
                    if (species.subSpecies && species.subSpecies.length > 0) {
                        matchedSubspecies = species.subSpecies.filter(sub => {
                            const subName = (sub.displayName || sub.name || sub.id || '').toLowerCase();
                            const matches = subName.includes(searchQuery);
                            if (matches) {
                                console.log(`  - Matched subspecies: ${sub.displayName}`);
                            }
                            return matches;
                        });
                    }

                    // ã‚±ãƒ¼ã‚¹1: åŸç¨®åã§ãƒãƒƒãƒ â†’ ã™ã¹ã¦ã®åœ’èŠ¸å“ç¨®ã‚’å±•é–‹
                    if (parentMatches) {
                        console.log(`  â†’ Parent match: showing all subspecies`);
                        return {
                            ...species,
                            showAsParentCard: true,  // åŸç¨®ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºãƒ•ãƒ©ã‚°
                            expandSubspecies: true   // åœ’èŠ¸å“ç¨®ã‚’å±•é–‹
                        };
                    }

                    // ã‚±ãƒ¼ã‚¹2: åœ’èŠ¸å“ç¨®åã§ãƒãƒƒãƒ â†’ è©²å½“ã™ã‚‹åœ’èŠ¸å“ç¨®ã®ã¿ã‚’åœ’èŠ¸å“ç¨®ã‚«ãƒ¼ãƒ‰ã§è¡¨ç¤º
                    if (matchedSubspecies.length > 0) {
                        console.log(`  â†’ Subspecies match: showing ${matchedSubspecies.length} subspecies cards`);
                        return {
                            ...species,
                            subSpecies: matchedSubspecies,
                            showAsSubspeciesCards: true  // åœ’èŠ¸å“ç¨®ã‚«ãƒ¼ãƒ‰ã¨ã—ã¦è¡¨ç¤º
                        };
                    }

                    // ã‚±ãƒ¼ã‚¹3: ãƒãƒƒãƒã—ãªã„ â†’ é™¤å¤–
                    console.log(`  â†’ No match: excluded`);
                    return null;
                }).filter(species => species !== null);

                console.log('Filtered species count:', filteredSpecies.length);
            }

            // åŸç¨®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆæ¤œç´¢ãŒç„¡åŠ¹ãªå ´åˆã®ã¿é©ç”¨ï¼‰
            if (!searchFilterActive && currentFilters.species !== 'all') {
                filteredSpecies = filteredSpecies.filter(species => {
                    return species.id === currentFilters.species ||
                           (currentFilters.species === 'hybrid' && species.type === 'hybrid');
                });
            }

            // æŠ•ç¨¿æ™‚æœŸãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆå¹´ãƒ»æœˆï¼‰
            let dateFilterActive = currentFilters.year !== 'all' || currentFilters.month !== 'all';

            if (dateFilterActive) {
                // æŠ•ç¨¿æ™‚æœŸã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                filteredSpecies = filteredSpecies.map(species => {
                    // åŸç¨®ã®åœ’èŠ¸å“ç¨®ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                    if (species.subSpecies && species.subSpecies.length > 0) {
                        const filteredSubs = species.subSpecies.filter(sub => {
                            if (!sub.latestPostDate) return false;

                            const [year, month] = sub.latestPostDate.split('-');

                            // å¹´ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                            if (currentFilters.year !== 'all' && year !== currentFilters.year) {
                                return false;
                            }

                            // æœˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                            if (currentFilters.month !== 'all') {
                                const filterMonth = currentFilters.month.split('-')[1];
                                if (month !== filterMonth) {
                                    return false;
                                }
                            }

                            return true;
                        });

                        // è©²å½“ã™ã‚‹åœ’èŠ¸å“ç¨®ãŒã‚ã‚‹å ´åˆã®ã¿åŸç¨®ã‚’æ®‹ã™
                        if (filteredSubs.length > 0) {
                            return {
                                ...species,
                                subSpecies: filteredSubs,
                                subSpeciesCount: filteredSubs.length
                            };
                        }
                    }

                    return null;
                }).filter(species => species !== null);
            }

            // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
            updateStats(filteredSpecies);

            // å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            // - æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒæœ‰åŠ¹ãªå ´åˆã¯ç‰¹åˆ¥ãªè¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯
            // - æŠ•ç¨¿æ™‚æœŸãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒæœ‰åŠ¹ãªå ´åˆã¯åœ’èŠ¸å“ç¨®ã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
            if (searchFilterActive) {
                renderSearchResults(filteredSpecies);
            } else if (dateFilterActive) {
                renderFilteredSpecies(filteredSpecies, dateFilterActive);
            } else {
                renderFilteredSpecies(filteredSpecies, false);
            }
        }

        // æ¤œç´¢çµæœå°‚ç”¨ã®è¡¨ç¤ºé–¢æ•°
        function renderSearchResults(filteredSpecies) {
            const pureSection = document.getElementById('pure-species-section');
            const hybridSection = document.getElementById('hybrid-species-section');
            const pureGrid = document.getElementById('pure-species-grid');

            let cards = [];

            filteredSpecies.forEach(species => {
                // ã‚±ãƒ¼ã‚¹1: åŸç¨®ã‚«ãƒ¼ãƒ‰è¡¨ç¤º + åœ’èŠ¸å“ç¨®ã‚’å±•é–‹
                if (species.showAsParentCard) {
                    // åŸç¨®ã‚«ãƒ¼ãƒ‰ã¯è¡¨ç¤ºã—ãªã„ï¼ˆé‡è¤‡ã‚’é¿ã‘ã‚‹ãŸã‚ï¼‰
                    // ã™ã¹ã¦ã®åœ’èŠ¸å“ç¨®ã‚’åœ’èŠ¸å“ç¨®ã‚«ãƒ¼ãƒ‰ã¨ã—ã¦è¡¨ç¤º
                    if (species.subSpecies && species.subSpecies.length > 0) {
                        species.subSpecies.forEach(sub => {
                            cards.push(createSubspeciesCard(sub));
                        });
                    }
                }
                // ã‚±ãƒ¼ã‚¹2: åœ’èŠ¸å“ç¨®ã‚«ãƒ¼ãƒ‰ã®ã¿è¡¨ç¤º
                else if (species.showAsSubspeciesCards) {
                    species.subSpecies.forEach(sub => {
                        cards.push(createSubspeciesCard(sub));
                    });
                }
            });

            if (cards.length > 0) {
                pureGrid.innerHTML = cards.join('');
                pureSection.classList.remove('hidden');
            } else {
                pureGrid.innerHTML = '<p class="text-gray-600 col-span-full text-center py-12">è©²å½“ã™ã‚‹å“ç¨®ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>';
                pureSection.classList.remove('hidden');
            }

            hybridSection.classList.add('hidden');
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¯ãƒªã‚¢
        function clearFilters() {
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.value = '';
            }
            searchQuery = '';

            currentFilters = {
                species: 'all',
                subspecies: 'all',
                year: 'all',
                month: 'all'
            };

            document.querySelectorAll('.filter-item').forEach(btn => {
                btn.classList.remove('filter-active');
                btn.classList.remove('disabled');
                if (btn.dataset.filterValue === 'all') {
                    btn.classList.add('filter-active');
                }
            });

            applyFilters();
        }

        // çµ±è¨ˆæƒ…å ±æ›´æ–°
        function updateStats(filteredSpecies) {
            const statsElement = document.getElementById('gallery-stats');
            if (statsElement) {
                const totalCount = allSpeciesData.length;
                const filteredCount = filteredSpecies.length;
                const totalPosts = filteredSpecies.reduce((sum, s) => sum + (s.totalPosts || s.count || 0), 0);

                // å…¨å“ç¨®ã‚¿ã‚¤ãƒ«æ•°ã‚’è¨ˆç®—
                let totalTiles = 0;
                allSpeciesData.forEach(item => {
                    if (item.type === 'pure' && item.subSpecies && item.subSpecies.length > 0) {
                        totalTiles += item.subSpecies.length;
                    } else {
                        totalTiles += 1;
                    }
                });

                if (filteredCount === totalCount) {
                    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æœªé©ç”¨æ™‚
                    statsElement.textContent = `å…¨${totalTiles}å“ç¨® / ${totalPosts}ä»¶ã®æŠ•ç¨¿`;
                } else {
                    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨æ™‚
                    statsElement.textContent = `${filteredCount}å“ç¨® / ${totalPosts}ä»¶ã®æŠ•ç¨¿ã‚’è¡¨ç¤ºä¸­ï¼ˆå…¨${totalTiles}å“ç¨®ï¼‰`;
                }
            }
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¸ˆã¿å“ç¨®ã‚’è¡¨ç¤º
        function renderFilteredSpecies(filteredSpecies, dateFilterActive = false) {
            const pureSection = document.getElementById('pure-species-section');
            const hybridSection = document.getElementById('hybrid-species-section');
            const pureGrid = document.getElementById('pure-species-grid');
            const hybridGrid = document.getElementById('hybrid-species-grid');

            // æŠ•ç¨¿æ™‚æœŸãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒæœ‰åŠ¹ãªå ´åˆã¯åœ’èŠ¸å“ç¨®ã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
            if (dateFilterActive) {
                let subspeciesCards = [];

                filteredSpecies.forEach(species => {
                    if (species.subSpecies && species.subSpecies.length > 0) {
                        species.subSpecies.forEach(sub => {
                            subspeciesCards.push(createSubspeciesCard(sub));
                        });
                    }
                });

                if (subspeciesCards.length > 0) {
                    pureGrid.innerHTML = subspeciesCards.join('');
                    pureSection.classList.remove('hidden');
                } else {
                    pureGrid.innerHTML = '<p class="text-gray-600 col-span-full text-center py-12">è©²å½“ã™ã‚‹å“ç¨®ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>';
                    pureSection.classList.remove('hidden');
                }

                hybridSection.classList.add('hidden');
                return;
            }

            // é€šå¸¸è¡¨ç¤ºï¼ˆåŸç¨®ã‚«ãƒ¼ãƒ‰ï¼‰
            const pureSpecies = filteredSpecies.filter(item => item.type === 'pure');
            const hybridSpecies = filteredSpecies.filter(item => item.type === 'hybrid');

            // äº¤é…ç¨®ã‚’1ã¤ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚«ãƒ¼ãƒ‰ã«ã¾ã¨ã‚ã‚‹
            const hasHybrids = allSpeciesData.some(item => item.type === 'hybrid');
            let hybridGroupCard = '';

            if (hasHybrids) {
                // å…¨äº¤é…ç¨®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å‰ã®å®Œå…¨ãªãƒ‡ãƒ¼ã‚¿ï¼‰
                const allHybrids = allSpeciesData.filter(item => item.type === 'hybrid');

                // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨å¾Œã«äº¤é…ç¨®ãŒå«ã¾ã‚Œã‚‹å ´åˆã®ã¿ã‚°ãƒ«ãƒ¼ãƒ—ã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
                if (hybridSpecies.length > 0 ||
                    (currentFilters.species === 'all' || currentFilters.species === 'hybrid')) {
                    hybridGroupCard = createHybridGroupCard(allHybrids);
                }
            }

            // åŸç¨®ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤º
            if (pureSpecies.length > 0 || hybridGroupCard) {
                let gridContent = pureSpecies.map(createSpeciesCard).join('');

                // äº¤é…ç¨®ã‚°ãƒ«ãƒ¼ãƒ—ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ 
                if (hybridGroupCard) {
                    gridContent += hybridGroupCard;
                }

                pureGrid.innerHTML = gridContent;
                pureSection.classList.remove('hidden');
            } else {
                pureSection.classList.add('hidden');
            }

            // äº¤é…ç¨®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯éè¡¨ç¤ºï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ã‚«ãƒ¼ãƒ‰ã§çµ±åˆã—ãŸãŸã‚ï¼‰
            hybridSection.classList.add('hidden');

            // çµæœãŒ0ä»¶ã®å ´åˆ
            if (pureSpecies.length === 0 && !hybridGroupCard) {
                pureGrid.innerHTML = '<p class="text-gray-600 col-span-full text-center py-12">è©²å½“ã™ã‚‹å“ç¨®ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>';
                pureSection.classList.remove('hidden');
            }
        }

        // åœ’èŠ¸å“ç¨®ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆï¼ˆãƒãƒƒã‚¸ã‚’å‰Šé™¤ï¼‰
        function createSubspeciesCard(subspecies) {
            const linkUrl = `/gallery/detail?id=${subspecies.id}`;

            const imageSrc = subspecies.latestImage
                ? `/${subspecies.latestImage}`
                : '/images/placeholder-leaf.svg';

            return `
                <div class="species-card bg-white rounded-lg shadow-md overflow-hidden fade-in"
                     onclick="window.location.href='${linkUrl}'">
                    <img src="${imageSrc}"
                         alt="${subspecies.displayName}"
                         class="species-thumbnail"
                         loading="lazy"
                         onerror="this.src='/images/placeholder-leaf.svg'">
                    <div class="p-6">
                        <div class="flex items-start justify-between mb-3">
                            <h3 class="text-2xl font-bold text-forest-dark">
                                ${subspecies.displayName}
                            </h3>
                        </div>
                        <div class="flex items-center justify-between text-sm text-gray-600">
                            <span>ğŸ“¸ ${subspecies.count || 0}ä»¶ã®æŠ•ç¨¿</span>
                            ${subspecies.latestPostDate ? `<span class="text-xs text-gray-500">æœ€çµ‚: ${subspecies.latestPostDate}</span>` : ''}
                        </div>
                    </div>
                    <div class="bg-forest-light bg-opacity-10 px-6 py-3 flex items-center justify-between">
                        <span class="text-sm text-forest-dark font-semibold">
                            æŠ•ç¨¿ã‚’è¦‹ã‚‹
                        </span>
                        <svg class="w-5 h-5 text-forest-mid" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>
                </div>
            `;
        }

        // äº¤é…ç¨®ã‚°ãƒ«ãƒ¼ãƒ—ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆï¼ˆãƒãƒƒã‚¸ã‚’å‰Šé™¤ï¼‰
        function createHybridGroupCard(allHybrids) {
            if (allHybrids.length === 0) return '';

            // çµ±è¨ˆæƒ…å ±ã‚’é›†è¨ˆ
            const totalHybridCount = allHybrids.length;
            const totalHybridPosts = allHybrids.reduce((sum, hybrid) =>
                sum + (hybrid.totalPosts || hybrid.count || 0), 0
            );

            // ä»£è¡¨ç”»åƒã‚’é¸æŠï¼ˆæŠ•ç¨¿æ•°ãŒæœ€ã‚‚å¤šã„äº¤é…ç¨®ã®ç”»åƒï¼‰
            const representativeHybrid = allHybrids.reduce((max, hybrid) =>
                (hybrid.totalPosts || 0) > (max.totalPosts || 0) ? hybrid : max
            , allHybrids[0]);

            const imageSrc = representativeHybrid.latestImage
                ? `/${representativeHybrid.latestImage}`
                : '/images/placeholder-leaf.svg';

            const linkUrl = '/gallery/subspecies?parent=hybrid';

            return `
                <div class="species-card bg-white rounded-lg shadow-md overflow-hidden fade-in"
                     onclick="window.location.href='${linkUrl}'">
                    <img src="${imageSrc}"
                         alt="äº¤é…ç¨® / Hybrids"
                         class="species-thumbnail"
                         loading="lazy"
                         onerror="this.src='/images/placeholder-leaf.svg'">
                    <div class="p-6">
                        <div class="flex items-start justify-between mb-3">
                            <h3 class="text-2xl font-bold text-forest-dark">
                                äº¤é…ç¨® / Hybrids
                            </h3>
                        </div>
                        <div class="flex items-center justify-between text-sm text-gray-600">
                            <span>ğŸ“¸ ${totalHybridPosts}ä»¶ã®æŠ•ç¨¿</span>
                            <span class="text-sm text-gray-500">ğŸŒ¿ ${totalHybridCount}å“ç¨®</span>
                        </div>
                    </div>
                    <div class="bg-forest-light bg-opacity-10 px-6 py-3 flex items-center justify-between">
                        <span class="text-sm text-forest-dark font-semibold">
                            å“ç¨®ã‚’è¦‹ã‚‹
                        </span>
                        <svg class="w-5 h-5 text-forest-mid" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>
                </div>
            `;
        }

        // å“ç¨®ã‚«ãƒ¼ãƒ‰ç”Ÿæˆé–¢æ•°ï¼ˆãƒãƒƒã‚¸ã‚’å‰Šé™¤ï¼‰
        function createSpeciesCard(species) {
            // åŸç¨®ã§åœ’èŠ¸å“ç¨®ãŒã‚ã‚‹å ´åˆã¯ subspecies.html ã«ãƒªãƒ³ã‚¯
            let linkUrl;
            if (species.type === 'pure' && species.subSpeciesCount > 0) {
                linkUrl = `/gallery/subspecies?parent=${species.id}`;
            } else {
                linkUrl = `/gallery/detail?id=${species.id}`;
            }

            const isHybrid = species.type === 'hybrid';

            // ç”»åƒã®è¡¨ç¤º
            let imageSrc = '/images/placeholder-leaf.svg';
            if (species.latestImage) {
                imageSrc = `/${species.latestImage}`;
            } else if (species.subSpecies && species.subSpecies.length > 0 && species.subSpecies[0].latestImage) {
                imageSrc = `/${species.subSpecies[0].latestImage}`;
            }

            // è‹±èªè¡¨è¨˜ã‚’ä½¿ç”¨
            const displayName = speciesNameMap[species.id] || species.displayName || species.name || species.id;

            // æŠ•ç¨¿æ•°ã®è¡¨ç¤º
            const postCount = species.totalPosts || species.count || 0;

            // åœ’èŠ¸å“ç¨®æ•°ã®è¡¨ç¤ºï¼ˆåŸç¨®ã®å ´åˆã®ã¿ï¼‰
            const subSpeciesInfo = species.type === 'pure' && species.subSpeciesCount > 0
                ? `<span class="text-sm text-gray-500">ğŸŒ¿ ${species.subSpeciesCount}å“ç¨®</span>`
                : '';

            return `
                <div class="species-card bg-white rounded-lg shadow-md overflow-hidden fade-in"
                     onclick="window.location.href='${linkUrl}'">
                    <img src="${imageSrc}"
                         alt="${displayName}"
                         class="species-thumbnail"
                         loading="lazy"
                         onerror="this.src='/images/placeholder-leaf.svg'">
                    <div class="species-card-content p-6">
                        <div>
                            <h3 class="text-xl font-bold text-forest-dark mb-3">
                                ${displayName}
                            </h3>
                            <div class="flex items-center justify-between text-sm text-gray-600">
                                <span>ğŸ“¸ ${postCount}ä»¶ã®æŠ•ç¨¿</span>
                                ${subSpeciesInfo}
                            </div>
                        </div>
                    </div>
                    <div class="species-card-footer bg-forest-light bg-opacity-10 px-6 justify-between">
                        <span class="text-sm text-forest-dark font-semibold">
                            ${species.type === 'pure' && species.subSpeciesCount > 0 ? 'å“ç¨®ã‚’è¦‹ã‚‹' : 'æŠ•ç¨¿ã‚’è¦‹ã‚‹'}
                        </span>
                        <svg class="w-5 h-5 text-forest-mid" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>
                </div>
            `;
        }

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«å®Ÿè¡Œ
        loadMainSpecies();
    </script>

    <!-- Accordion Toggle -->
    <script is:inline>
        window.toggleAccordion = function(accordionId) {
            const content = document.getElementById(accordionId);
            const icon = document.getElementById(accordionId + '-icon');

            if (content && icon) {
                content.classList.toggle('open');
                icon.classList.toggle('rotate');
            }
        }
    </script>


</BaseLayout>
