---
import BaseLayout from '../../layouts/BaseLayout.astro';
---

<BaseLayout title="å“ç¨®åˆ¥è©³ç´° - Platycerium Collection">
  <style is:global>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(180deg, #ffffff 0%, #f9fafb 50%, #f3f4f6 100%);
      min-height: 100vh;
    }

    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }

    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒˆãƒ« */
    .gradient-title {
      background: linear-gradient(135deg, #059669 0%, #10b981 25%, #34d399 50%, #10b981 75%, #059669 100%);
      background-size: 200% auto;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: gradientShift 8s ease infinite;
    }

    @keyframes gradientShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    .post-card {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      display: flex;
      flex-direction: column;
      height: 100%;
      background: white;
      border-radius: 1rem;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    .post-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 24px rgba(16, 185, 129, 0.15);
    }

    .line-clamp-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .post-image {
      aspect-ratio: 1 / 1;
      object-fit: cover;
    }

    /* æ ½åŸ¹ç®¡ç†ã‚¿ã‚°ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .care-tag {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      color: white;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .care-tag:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* Day ãƒãƒƒã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .day-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background: linear-gradient(135deg, #059669 0%, #10b981 100%);
      color: white;
      padding: 0.625rem 1.25rem;
      border-radius: 9999px;
      font-weight: 700;
      font-size: 0.875rem;
      box-shadow: 0 4px 8px rgba(5, 150, 105, 0.3);
      transition: all 0.2s ease;
    }

    .day-badge:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(5, 150, 105, 0.4);
    }

    /* ã‚¿ã‚°ã”ã¨ã®è‰²è¨­å®šï¼ˆã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã§çµ±ä¸€ï¼‰ */
    .care-tag-purchase {
      background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
    }

    .care-tag-remount {
      background: linear-gradient(135deg, #059669 0%, #10b981 100%);
    }

    .care-tag-moss {
      background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
    }

    .care-tag-fertilize {
      background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%);
    }

    /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
    @media (max-width: 768px) {
      .care-tag {
        font-size: 0.7rem;
        padding: 0.3rem 0.6rem;
      }

      .day-badge {
        padding: 0.4rem 0.8rem;
        font-size: 0.875rem;
      }
    }
  </style>

  <main class="container mx-auto px-4 py-8">
    <!-- Breadcrumb -->
    <nav class="mb-6 text-sm text-gray-600 flex items-center flex-wrap">
      <a href="/" class="hover:text-forest-mid transition-colors">ãƒ›ãƒ¼ãƒ </a>
      <span class="mx-2">/</span>
      <a href="/gallery/" class="hover:text-forest-mid transition-colors">æ ½åŸ¹è¨˜éŒ²</a>
      <span id="breadcrumb-species-separator" class="mx-2 hidden">/</span>
      <a id="breadcrumb-species-link" href="#" class="hover:text-forest-mid transition-colors hidden">...</a>
      <span class="mx-2">/</span>
      <span id="breadcrumb-subspecies" class="text-forest-dark font-semibold">...</span>
    </nav>

    <!-- Species Header -->
    <div class="relative backdrop-blur-sm bg-white/95 rounded-2xl shadow-lg border-2 border-emerald-500 p-8 mb-8 overflow-hidden">
      <!-- è£…é£¾çš„ãªèƒŒæ™¯ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ -->
      <div class="absolute inset-0 bg-gradient-to-br from-emerald-50/50 via-transparent to-emerald-50/30 pointer-events-none"></div>

      <div class="relative">
        <div class="flex items-start justify-between mb-6">
          <div class="flex-1">
            <h1 id="species-name-ja" class="text-3xl md:text-4xl font-bold gradient-title mb-4">
              <!-- JavaScript ã§è¨­å®š -->
            </h1>
            <div class="flex items-center gap-3 text-gray-600">
              <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
              <p id="species-count" class="font-medium">
                <!-- JavaScript ã§è¨­å®š -->
              </p>
            </div>
          </div>
        </div>

        <!-- å†™çœŸã¨ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ -->
        <div id="latest-image-container" class="mt-8 hidden">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- å·¦å´ï¼šå†™çœŸ -->
            <div class="relative rounded-xl overflow-hidden shadow-md border-2 border-emerald-200 flex items-center justify-center bg-white">
              <img id="latest-image" src="" alt="å“ç¨®ã®å†™çœŸ" class="w-full h-auto">
            </div>

            <!-- å³å´ï¼šã‚³ãƒ¡ãƒ³ãƒˆæ¬„ -->
            <div class="flex flex-col h-full">
              <div class="mb-4">
                <h3 class="text-lg font-bold text-gray-800 mb-2 flex items-center gap-2">
                  <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                  </svg>
                  æ ½åŸ¹ãƒ¡ãƒ¢
                </h3>
                <p class="text-sm text-gray-600 leading-relaxed">
                  ã“ã®å“ç¨®ã®ç‰¹å¾´ã‚„è‚²ã¦æ–¹ã®ãƒã‚¤ãƒ³ãƒˆã€è¦³å¯Ÿã—ãŸã“ã¨ãªã©ã‚’è¨˜éŒ²ã§ãã¾ã™
                </p>
              </div>

              <div class="flex-1 flex flex-col">
                <textarea
                  id="species-comment"
                  class="w-full flex-1 p-5 bg-white rounded-xl border-2 border-gray-300 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-100 transition-all resize-none text-gray-700 text-base leading-relaxed min-h-[250px]"
                  placeholder="ä¾‹ï¼š&#10;ãƒ»è‘‰ãŒå¤§ããæˆé•·ãŒæ—©ã„&#10;ãƒ»æ°´ã‚„ã‚Šã¯é€±2å›ç¨‹åº¦&#10;ãƒ»èƒå­è‘‰ã®å½¢ãŒç¾ã—ã„&#10;ãƒ»å¤å ´ã¯é®å…‰ãŒå¿…è¦"
                  disabled
                ></textarea>
                <div class="mt-3 flex items-center justify-between">
                  <p class="text-xs text-gray-500">
                    <span class="inline-flex items-center gap-1">
                      <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                      </svg>
                      æº–å‚™ä¸­ã®æ©Ÿèƒ½ã§ã™
                    </span>
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading" class="text-center py-12">
      <div class="inline-flex items-center gap-2 text-gray-600">
        <svg class="animate-spin h-8 w-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span class="text-lg">æŠ•ç¨¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</span>
      </div>
    </div>

    <!-- Error Message -->
    <div id="error" class="hidden text-center py-12">
      <div class="inline-block p-8 bg-white rounded-2xl shadow-lg border-2 border-red-200">
        <svg class="w-16 h-16 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <p class="text-xl text-red-600 mb-6 font-semibold"></p>
        <div class="flex gap-4 justify-center">
          <button onclick="location.reload()" class="bg-gradient-to-r from-emerald-600 to-emerald-500 hover:from-emerald-700 hover:to-emerald-600 text-white font-semibold py-3 px-8 rounded-xl transition-all shadow-md hover:shadow-lg">
            å†èª­ã¿è¾¼ã¿
          </button>
          <a href="/gallery/" class="inline-block bg-white hover:bg-gray-50 text-gray-700 font-semibold py-3 px-8 rounded-xl transition-all shadow-md hover:shadow-lg border-2 border-gray-300">
            æ ½åŸ¹è¨˜éŒ²ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹
          </a>
        </div>
      </div>
    </div>

    <!-- Posts Grid -->
    <div id="posts-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 auto-rows-fr">
      <!-- Posts will be rendered here -->
    </div>

    <!-- Back to Top Button -->
    <div class="mt-12 mb-8 text-center">
      <a id="back-to-gallery" href="/gallery/" class="inline-flex items-center gap-2 bg-gradient-to-r from-emerald-600 to-emerald-500 hover:from-emerald-700 hover:to-emerald-600 text-white font-semibold py-4 px-10 rounded-xl transition-all shadow-lg hover:shadow-xl">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
        æ ½åŸ¹è¨˜éŒ²ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹
      </a>
    </div>
  </main>

  <script is:inline type="module">
    // ========================================
    // Text Cleaner Utility Functions
    // ========================================

    /**
     * çµµæ–‡å­—ã¨ç‰¹æ®Šè¨˜å·ã‚’å‰Šé™¤ï¼ˆå®Œå…¨ç‰ˆï¼‰
     * @param {string} text - ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°å¯¾è±¡ã®ãƒ†ã‚­ã‚¹ãƒˆ
     * @returns {string} - ã‚¯ãƒªãƒ¼ãƒ³ãªãƒ†ã‚­ã‚¹ãƒˆ
     */
    function removeEmojisAndSymbols(text) {
      if (!text) return '';

      let cleaned = text;

      // çµµæ–‡å­—ã®å®Œå…¨å‰Šé™¤ï¼ˆã™ã¹ã¦ã®Unicodeç¯„å›²ï¼‰
      cleaned = cleaned.replace(/[\u{1F300}-\u{1F9FF}]/gu, ''); // ã™ã¹ã¦ã®çµµæ–‡å­—ï¼ˆU+1F300-1F9FFï¼‰
      cleaned = cleaned.replace(/[\u{2600}-\u{27BF}]/gu, '');   // ãã®ä»–è¨˜å·ï¼ˆU+2600-27BFï¼‰
      cleaned = cleaned.replace(/[\u{1F000}-\u{1F02F}]/gu, ''); // éº»é›€ç‰Œç­‰
      cleaned = cleaned.replace(/[\u{1F0A0}-\u{1F0FF}]/gu, ''); // ãƒˆãƒ©ãƒ³ãƒ—
      cleaned = cleaned.replace(/[\u{1FA00}-\u{1FA6F}]/gu, ''); // æ‹¡å¼µçµµæ–‡å­—A
      cleaned = cleaned.replace(/[\u{1FA70}-\u{1FAFF}]/gu, ''); // æ‹¡å¼µçµµæ–‡å­—B
      cleaned = cleaned.replace(/[\u{2300}-\u{23FF}]/gu, '');   // æŠ€è¡“è¨˜å·
      cleaned = cleaned.replace(/[\u{2B50}\u{2B55}]/gu, '');    // æ˜Ÿãƒ»å††
      cleaned = cleaned.replace(/[\u{FE00}-\u{FE0F}]/gu, '');   // ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚»ãƒ¬ã‚¯ã‚¿
      cleaned = cleaned.replace(/[\u{E0020}-\u{E007F}]/gu, ''); // ã‚¿ã‚°

      // çµµæ–‡å­—ã®Zero Width Joinerï¼ˆçµåˆæ–‡å­—ï¼‰ã‚’å‰Šé™¤
      cleaned = cleaned.replace(/\u200D/gu, '');

      // ç‰¹æ®ŠãªUnicodeæ–‡å­—ï¼ˆâ–¡ã‚„è±†è…æ–‡å­—ï¼‰ã‚’å‰Šé™¤
      cleaned = cleaned.replace(/[\uFFFD\u25A1\u25A0]/g, ''); // â–¡, â– , ï¿½

      // åˆ¶å¾¡æ–‡å­—ï¼ˆè¦‹ãˆãªã„æ–‡å­—ï¼‰
      cleaned = cleaned.replace(/[\u{0000}-\u{001F}]/gu, '');
      cleaned = cleaned.replace(/[\u{007F}-\u{009F}]/gu, '');

      return cleaned;
    }

    /**
     * ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’ç¢ºå®Ÿã«å‰Šé™¤ï¼ˆå¤šæ®µéšå‡¦ç†ï¼‰
     * @param {string} text - ãƒ†ã‚­ã‚¹ãƒˆ
     * @returns {string} - ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ãªã—ã®ãƒ†ã‚­ã‚¹ãƒˆ
     */
    function removeHashtagsMultipass(text) {
      if (!text) return '';

      let cleaned = text;

      // ã‚¹ãƒ†ãƒƒãƒ—1: è¡Œæœ«ã®ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ãƒ–ãƒ­ãƒƒã‚¯ã‚’å‰Šé™¤
      // ä¾‹: "ãƒ†ã‚­ã‚¹ãƒˆ\n\n#ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°1 \n#ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°2\n#ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°3"
      cleaned = cleaned.replace(/\n\n[#\s]+.*$/s, '');

      // ã‚¹ãƒ†ãƒƒãƒ—2: å€‹åˆ¥ã®ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’å‰Šé™¤ï¼ˆè¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
      cleaned = cleaned.replace(/#[\p{L}\p{N}_]+/gu, ''); // Unicodeæ–‡å­—å¯¾å¿œ
      cleaned = cleaned.replace(/#[^\s#\n]+/g, '');       // ç©ºç™½ãƒ»æ”¹è¡Œä»¥å¤–
      cleaned = cleaned.replace(/#\S+/g, '');              // ç©ºç™½ä»¥å¤–
      cleaned = cleaned.replace(/#/g, '');                 // æ®‹ã£ãŸ#è¨˜å·ã‚‚å‰Šé™¤

      // ã‚¹ãƒ†ãƒƒãƒ—3: è¤‡æ•°ã®ç©ºç™½ãƒ»æ”¹è¡Œã‚’æ•´ç†
      cleaned = cleaned.replace(/\n\s*\n\s*\n/g, '\n\n'); // 3ã¤ä»¥ä¸Šã®æ”¹è¡Œã‚’2ã¤ã«
      cleaned = cleaned.replace(/\s+/g, ' ');              // è¤‡æ•°ã®ç©ºç™½ã‚’1ã¤ã«
      cleaned = cleaned.replace(/\n /g, '\n');             // æ”¹è¡Œå¾Œã®ç©ºç™½å‰Šé™¤

      // ã‚¹ãƒ†ãƒƒãƒ—4: å‰å¾Œã®ç©ºç™½ã‚’å‰Šé™¤
      cleaned = cleaned.trim();

      return cleaned;
    }

    /**
     * ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã«ã™ã‚‹ï¼ˆçµµæ–‡å­— + ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°å‰Šé™¤ï¼‰
     * @param {string} caption - ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
     * @returns {string} - ã‚¯ãƒªãƒ¼ãƒ³ãªã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³
     */
    function cleanCaption(caption) {
      if (!caption) return '';

      let cleaned = caption;

      // ã‚¹ãƒ†ãƒƒãƒ—1: ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’å…ˆã«å‰Šé™¤
      cleaned = removeHashtagsMultipass(cleaned);

      // ã‚¹ãƒ†ãƒƒãƒ—2: çµµæ–‡å­—ã¨ç‰¹æ®Šè¨˜å·ã‚’å‰Šé™¤
      cleaned = removeEmojisAndSymbols(cleaned);

      // ã‚¹ãƒ†ãƒƒãƒ—3: æœ€çµ‚ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
      cleaned = cleaned.replace(/\s+/g, ' ').trim();

      return cleaned;
    }

    /**
     * ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã‹ã‚‰æ ½åŸ¹ç®¡ç†ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’æ¤œå‡º
     * ç‰¹è¨˜ã™ã¹ãã‚¿ã‚°ï¼ˆæ¿æ›¿ãˆã€è‹”å¢—ã—ã€è¿½è‚¥ï¼‰ã®ã¿ã‚’æŠ½å‡º
     * @param {string} caption - ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
     * @returns {Array<{emoji: string, label: string, type: string}>} - æ¤œå‡ºã•ã‚ŒãŸã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã®é…åˆ—
     */
    function extractCareActivities(caption) {
      if (!caption) return [];

      const activities = [];

      // æ¿æ›¿ãˆï¼ˆãƒªãƒã‚¦ãƒ³ãƒˆï¼‰
      if (/æ¿æ›¿ãˆ|ãƒªãƒã‚¦ãƒ³ãƒˆ|remount|æ¿ä»˜ã‘/i.test(caption)) {
        activities.push({
          emoji: 'ğŸŒ±',
          label: 'æ¿æ›¿ãˆ',
          type: 'remount'
        });
      }

      // è‹”å¢—ã—
      if (/è‹”å¢—ã—|è‹”(?!æ›¿)|moss/i.test(caption)) {
        activities.push({
          emoji: 'ğŸŒ¿',
          label: 'è‹”å¢—ã—',
          type: 'moss'
        });
      }

      // è¿½è‚¥
      if (/è¿½è‚¥|è‚¥æ–™|ãƒã‚°ã‚¡ãƒ³ãƒ—|magamp|fertiliz/i.test(caption)) {
        activities.push({
          emoji: 'ğŸ’Š',
          label: 'è¿½è‚¥',
          type: 'fertilize'
        });
      }

      return activities;
    }

    // ========================================
    // Species Detail App
    // ========================================

    // DOMè¦ç´ 
    const speciesNameJa = document.getElementById('species-name-ja');
    const speciesCount = document.getElementById('species-count');
    const speciesDescription = document.getElementById('species-description');
    const breadcrumbSpeciesLink = document.getElementById('breadcrumb-species-link');
    const breadcrumbSubspecies = document.getElementById('breadcrumb-subspecies');
    const postsContainer = document.getElementById('posts-container');
    const loadingElement = document.getElementById('loading');
    const errorElement = document.getElementById('error');

    // çŠ¶æ…‹ç®¡ç†
    let speciesData = null;

    /**
     * URLã‹ã‚‰å“ç¨®IDã‚’å–å¾—
     */
    function getSpeciesIdFromURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get('id');
    }

    /**
     * å“ç¨®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
     */
    async function loadSpeciesData(speciesId) {
      try {
        const url = `/data/species/${speciesId}.json`;
        const response = await fetch(url);

        if (!response.ok) {
          if (response.status === 404) {
            throw new Error('æŒ‡å®šã•ã‚ŒãŸå“ç¨®ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
          }
          throw new Error(`ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ (${response.status})`);
        }

        const data = await response.json();

        // ãƒ‡ãƒ¼ã‚¿ã¯ã™ã§ã«ã‚µãƒ¼ãƒãƒ¼å´ã§ãƒ‡ã‚³ãƒ¼ãƒ‰æ¸ˆã¿
        return data;

      } catch (error) {
        console.error('å“ç¨®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        throw error;
      }
    }

    /**
     * æ—¥ä»˜ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆYYYYå¹´MMæœˆDDæ—¥ï¼‰
     */
    function formatDateJapanese(dateString) {
      const date = new Date(dateString);
      const year = date.getFullYear();
      const month = date.getMonth() + 1;
      const day = date.getDate();
      return `${year}å¹´${month}æœˆ${day}æ—¥`;
    }

    /**
     * æ—¥ä»˜ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆYYYY/MM/DDï¼‰
     */
    function formatDateShort(dateString) {
      const date = new Date(dateString);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}/${month}/${day}`;
    }

    /**
     * çµŒéæ—¥æ•°ã‚’è¨ˆç®—
     * @param {number} baseTimestamp - åŸºæº–æ—¥ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆç§’ï¼‰
     * @param {number} currentTimestamp - ç¾åœ¨ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆç§’ï¼‰
     * @returns {number} - çµŒéæ—¥æ•°
     */
    function calculateDaysSince(baseTimestamp, currentTimestamp) {
      const diffMs = (currentTimestamp - baseTimestamp) * 1000;
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      return diffDays;
    }

    /**
     * ç›¸å¯¾æ™‚é–“ã‚’è¡¨ç¤ºï¼ˆä¾‹: "3ãƒ¶æœˆå‰"ï¼‰
     */
    function getRelativeTime(timestamp) {
      const now = Date.now();
      const postDate = timestamp * 1000;
      const diffMs = now - postDate;
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

      if (diffDays === 0) return 'ä»Šæ—¥';
      if (diffDays === 1) return 'æ˜¨æ—¥';
      if (diffDays < 7) return `${diffDays}æ—¥å‰`;
      if (diffDays < 30) return `${Math.floor(diffDays / 7)}é€±é–“å‰`;
      if (diffDays < 365) return `${Math.floor(diffDays / 30)}ãƒ¶æœˆå‰`;
      return `${Math.floor(diffDays / 365)}å¹´å‰`;
    }

    /**
     * æŠ•ç¨¿ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆï¼ˆæˆé•·ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³çµ±åˆç‰ˆï¼‰
     */
    function createPostCard(post, isFirstPost, baseTimestamp) {
      const card = document.createElement('a');
      card.href = `/detail?id=${post.id}`;
      card.className = 'post-card bg-white rounded-lg shadow-md overflow-hidden block hover:shadow-xl transition-shadow';

      // ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³ã‚’æ•´å½¢ï¼ˆçµµæ–‡å­—ã¨ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’å‰Šé™¤ï¼‰
      const captionText = post.caption || '';
      const cleanedCaption = cleanCaption(captionText);

      // æ ½åŸ¹ç®¡ç†ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’æ¤œå‡º
      const careActivities = extractCareActivities(captionText);

      // Dayè¨ˆç®—
      const dayNumber = calculateDaysSince(baseTimestamp, post.timestamp);

      // ç”»åƒ
      const imgContainer = document.createElement('div');
      imgContainer.className = 'w-full bg-gray-200 relative';

      const firstImage = post.images && post.images[0];
      if (firstImage) {
        const img = document.createElement('img');
        img.src = `/${firstImage.path}`;
        // ALTå±æ€§ã‚’æœ€é©åŒ–ï¼ˆ50æ–‡å­—ä»¥å†…ã€çµµæ–‡å­—ãƒ»ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ãªã—ï¼‰
        const altText = cleanedCaption.split('\n')[0].substring(0, 50);
        img.alt = altText || 'æŠ•ç¨¿ç”»åƒ';
        img.className = 'post-image w-full aspect-square object-cover';
        img.loading = 'lazy';

        // ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼å¯¾å¿œ
        img.onerror = () => {
          img.src = '/images/placeholder.jpg';
        };

        imgContainer.appendChild(img);

        // è¤‡æ•°ç”»åƒã®å ´åˆã¯ãƒãƒƒã‚¸ã‚’è¡¨ç¤º
        if (post.images.length > 1) {
          const badge = document.createElement('div');
          badge.className = 'absolute top-2 right-2 bg-black bg-opacity-60 text-white text-xs px-2 py-1 rounded';
          badge.textContent = `${post.images.length}æš`;
          imgContainer.appendChild(badge);
        }
      }

      // ã‚«ãƒ¼ãƒ‰æœ¬ä½“
      const content = document.createElement('div');
      content.className = 'p-4';

      // Dayè¡¨ç¤º
      const dayBadge = document.createElement('div');
      dayBadge.className = 'inline-flex items-center gap-2 bg-gradient-to-r from-forest-mid to-forest-light text-white px-3 py-1.5 rounded-full font-bold text-sm mb-3';
      dayBadge.innerHTML = `
        <span class="text-xs opacity-90">Day</span>
        <span class="text-lg">${dayNumber}</span>
      `;

      // æŠ•ç¨¿æ—¥
      const dateElement = document.createElement('div');
      dateElement.className = 'mb-3';
      const dateShort = formatDateShort(post.date);
      const relativeTime = getRelativeTime(post.timestamp);

      dateElement.innerHTML = `
        <div class="flex items-center gap-2 text-sm font-semibold text-gray-700 mb-1">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
          </svg>
          <span>${dateShort}</span>
        </div>
        <div class="text-xs text-gray-500 ml-6">
          ${relativeTime}
        </div>
      `;

      // æ ½åŸ¹ç®¡ç†ã‚¿ã‚°
      const tagsContainer = document.createElement('div');
      tagsContainer.className = 'flex flex-wrap gap-2 mb-3';

      // è³¼å…¥ã‚¿ã‚°ã¯æœ€åˆã®æŠ•ç¨¿ï¼ˆDay 0ï¼‰ã®ã¿ã«è¡¨ç¤º
      if (isFirstPost) {
        const purchaseTag = document.createElement('span');
        purchaseTag.className = 'care-tag care-tag-purchase inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-semibold bg-red-500 text-white';
        purchaseTag.textContent = 'ğŸ›’ è³¼å…¥';
        tagsContainer.appendChild(purchaseTag);
      }

      // ãã®ä»–ã®ã‚¿ã‚°
      careActivities.forEach(activity => {
        const tag = document.createElement('span');
        const colorClass = {
          'remount': 'bg-green-500',
          'moss': 'bg-indigo-500',
          'fertilize': 'bg-amber-500',
          'pruning': 'bg-purple-500',
          'watering': 'bg-blue-500',
          'location': 'bg-teal-500'
        }[activity.type] || 'bg-gray-500';

        tag.className = `care-tag care-tag-${activity.type} inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-semibold ${colorClass} text-white`;
        tag.textContent = `${activity.emoji} ${activity.label}`;
        tagsContainer.appendChild(tag);
      });

      // ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³
      const title = document.createElement('p');
      title.className = 'text-gray-700 text-sm line-clamp-3';
      title.textContent = cleanedCaption || 'æŠ•ç¨¿è©³ç´°';

      content.appendChild(dayBadge);
      content.appendChild(dateElement);
      if (tagsContainer.children.length > 0) {
        content.appendChild(tagsContainer);
      }
      content.appendChild(title);

      card.appendChild(imgContainer);
      card.appendChild(content);

      return card;
    }

    /**
     * æŠ•ç¨¿ã‚°ãƒªãƒƒãƒ‰ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆå¤ã„é †ï¼‰
     */
    function renderPosts(posts) {
      postsContainer.innerHTML = '';

      if (posts.length === 0) {
        postsContainer.innerHTML = '<p class="text-center text-gray-600 col-span-full py-12">æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        return;
      }

      // ã‚½ãƒ¼ãƒˆ: å¤ã„é †ï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ˜‡é †ï¼‰
      const sortedPosts = [...posts].sort((a, b) => a.timestamp - b.timestamp);

      // æœ€å¤ã®æŠ•ç¨¿ã‚’Day 0ã¨ã—ã¦è¨­å®š
      const baseTimestamp = sortedPosts[0].timestamp;

      sortedPosts.forEach((post, index) => {
        const isFirstPost = index === 0; // æœ€åˆã®æŠ•ç¨¿ã®ã¿è³¼å…¥ã‚¿ã‚°ã‚’è¡¨ç¤º
        const card = createPostCard(post, isFirstPost, baseTimestamp);
        postsContainer.appendChild(card);
      });

      // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      postsContainer.classList.add('fade-in');
    }

    /**
     * ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ›´æ–°
     */
    function updateHeader() {
      // ãƒ‡ãƒ¼ã‚¿ã®å­˜åœ¨ç¢ºèª
      if (!speciesData || !speciesData.species) {
        console.error('å“ç¨®ãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ã§ã™:', speciesData);
        throw new Error('å“ç¨®ãƒ‡ãƒ¼ã‚¿ã®æ§‹é€ ãŒä¸æ­£ã§ã™');
      }

      const { species, posts } = speciesData;
      const count = species.count;

      const displayName = species.displayName || species.id;

      // DOMè¦ç´ ã®å­˜åœ¨ç¢ºèª
      if (!speciesNameJa) {
        console.error('å¿…è¦ãªDOMè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        console.error('speciesNameJa:', speciesNameJa);
        throw new Error('ãƒšãƒ¼ã‚¸ã®HTMLæ§‹é€ ãŒä¸æ­£ã§ã™');
      }

      speciesNameJa.textContent = displayName;

      // ç¨®åã‚’æŠ½å‡ºï¼ˆä¾‹: "P.willinckii æœˆå…‰çˆªå“‡" ã‹ã‚‰ "P.willinckii" ã‚’æŠ½å‡ºï¼‰
      // ã¾ãŸã¯ "Platycerium ridleyi nano" ã‹ã‚‰ "P. ridleyi" ã‚’æŠ½å‡º
      let speciesNameMatch = displayName.match(/^P\.(\w+)/);

      // "P." ã§å§‹ã¾ã‚‰ãªã„å ´åˆã¯ "Platycerium" ã‚’è©¦ã™
      if (!speciesNameMatch) {
        speciesNameMatch = displayName.match(/^Platycerium\s+(\w+)/);
      }

      if (speciesNameMatch) {
        const speciesKey = speciesNameMatch[1]; // ä¾‹: "willinckii" ã¾ãŸã¯ "ridleyi"
        const speciesNameEn = `P. ${speciesKey}`; // è‹±èªè¡¨è¨˜ï¼ˆä¾‹: "P. willinckii"ï¼‰

        // ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆã«ç¨®åãƒªãƒ³ã‚¯ã‚’è¨­å®šï¼ˆæ ½åŸ¹è¨˜éŒ²ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹ï¼‰
        const breadcrumbSeparator = document.getElementById('breadcrumb-species-separator');
        breadcrumbSpeciesLink.textContent = speciesNameEn;
        breadcrumbSpeciesLink.href = `/gallery/#${speciesKey}`;
        breadcrumbSpeciesLink.classList.remove('hidden');
        breadcrumbSeparator.classList.remove('hidden');

        // å“ç¨®åã‚’è¨­å®š
        breadcrumbSubspecies.textContent = displayName;

        // ãƒšãƒ¼ã‚¸ä¸‹éƒ¨ã®ã€Œæˆ»ã‚‹ã€ãƒœã‚¿ãƒ³ã«ã‚‚åŸç¨®IDã®ãƒãƒƒã‚·ãƒ¥ã‚’è¨­å®š
        const backToGalleryBtn = document.getElementById('back-to-gallery');
        if (backToGalleryBtn) {
          backToGalleryBtn.href = `/gallery/#${speciesKey}`;
        }
      } else {
        // ç¨®åãŒæŠ½å‡ºã§ããªã„å ´åˆï¼ˆäº¤é…ç¨®ãªã©ï¼‰
        breadcrumbSubspecies.textContent = displayName;

        // äº¤é…ç¨®ã®å ´åˆã¯ hybrid ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«æˆ»ã‚‹
        const backToGalleryBtn = document.getElementById('back-to-gallery');
        if (backToGalleryBtn) {
          backToGalleryBtn.href = `/gallery/#hybrid`;
        }
      }

      // æˆé•·æœŸé–“ã‚’è¡¨ç¤ºï¼ˆå¤ã„é †ã«ã‚½ãƒ¼ãƒˆæ¸ˆã¿ï¼‰
      const sortedPosts = [...posts].sort((a, b) => a.timestamp - b.timestamp);

      if (sortedPosts.length > 0) {
        const firstDate = formatDateJapanese(sortedPosts[0].date);
        const lastDate = formatDateJapanese(sortedPosts[sortedPosts.length - 1].date);

        // çµŒéæ—¥æ•°ã‚’è¨ˆç®—
        const totalDays = calculateDaysSince(sortedPosts[0].timestamp, sortedPosts[sortedPosts.length - 1].timestamp);

        speciesCount.textContent = `${count}ä»¶ã®æŠ•ç¨¿ / ${firstDate} ã€œ ${lastDate}ï¼ˆ${totalDays}æ—¥é–“ï¼‰`;

        // è¡¨ç¤ºã™ã‚‹æŠ•ç¨¿ç”»åƒã‚’æ±ºå®š
        let displayPost;

        // æœˆå…‰çˆªå“‡ã®å ´åˆã¯2025å¹´3æœˆ29æ—¥ã®æŠ•ç¨¿ã‚’ä½¿ç”¨
        if (species.id === 'ã‚¸ã‚µã‚¯ãƒœæœˆå…‰') {
          displayPost = posts.find(post => post.date === '2025-03-29');
          // è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯æœ€æ–°ã®æŠ•ç¨¿ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          if (!displayPost) {
            displayPost = sortedPosts[sortedPosts.length - 1];
          }
        } else {
          // ãã®ä»–ã®å“ç¨®ã¯æœ€æ–°ã®æŠ•ç¨¿ã‚’ä½¿ç”¨
          displayPost = sortedPosts[sortedPosts.length - 1];
        }

        const latestImageContainer = document.getElementById('latest-image-container');
        const latestImageElement = document.getElementById('latest-image');

        if (displayPost && displayPost.images && displayPost.images.length > 0) {
          const firstImage = displayPost.images[0];
          latestImageElement.src = `/${firstImage.path}`;
          latestImageElement.alt = `${displayName}ã®å†™çœŸ`;
          latestImageContainer.classList.remove('hidden');

          // ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼å¯¾å¿œ
          latestImageElement.onerror = () => {
            latestImageElement.src = '/images/placeholder.jpg';
          };
        }
      } else {
        speciesCount.textContent = `${count}ä»¶ã®æŠ•ç¨¿`;
      }

      // èª¬æ˜æ–‡ãŒã‚ã‚Œã°è¡¨ç¤º
      if (species.description) {
        speciesDescription.textContent = species.description;
        speciesDescription.classList.remove('hidden');
      }
    }

    /**
     * ãƒšãƒ¼ã‚¸ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
     */
    function updateMetadata() {
      const { species } = speciesData;
      const displayName = species.displayName || species.id;
      const title = `${displayName} - Platycerium Collection`;

      const pageTitle = document.getElementById('page-title');
      const ogTitle = document.getElementById('og-title');
      const twitterTitle = document.getElementById('twitter-title');

      if (pageTitle) pageTitle.textContent = title;
      if (ogTitle) ogTitle.setAttribute('content', title);
      if (twitterTitle) twitterTitle.setAttribute('content', title);
    }

    /**
     * ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
     */
    function showError(message) {
      loadingElement.classList.add('hidden');
      errorElement.classList.remove('hidden');
      errorElement.querySelector('p').textContent = message;
    }

    /**
     * åˆæœŸåŒ–
     */
    async function init() {
      try {
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        loadingElement.classList.remove('hidden');
        errorElement.classList.add('hidden');

        // URLã‹ã‚‰å“ç¨®IDã‚’å–å¾—
        const speciesId = getSpeciesIdFromURL();

        if (!speciesId) {
          throw new Error('å“ç¨®IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        }

        // å“ç¨®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        speciesData = await loadSpeciesData(speciesId);

        // ãƒ˜ãƒƒãƒ€ãƒ¼æ›´æ–°
        updateHeader();

        // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ›´æ–°
        updateMetadata();

        // æŠ•ç¨¿ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆå¤ã„é †ï¼‰
        renderPosts(speciesData.posts);

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º
        loadingElement.classList.add('hidden');

        const displayName = speciesData.species.displayName || speciesData.species.id;
        console.log(`å“ç¨®: ${displayName}, æŠ•ç¨¿æ•°: ${speciesData.species.count}`);

        // ã‚½ãƒ¼ãƒˆæ¸ˆã¿ã®æŠ•ç¨¿ã§æœŸé–“ã‚’è¡¨ç¤º
        const sortedPosts = [...speciesData.posts].sort((a, b) => a.timestamp - b.timestamp);
        console.log(`æœŸé–“: ${sortedPosts[0]?.date} ã€œ ${sortedPosts[sortedPosts.length - 1]?.date}`);

      } catch (error) {
        console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        showError(error.message || 'å“ç¨®ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
      }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
    document.addEventListener('DOMContentLoaded', init);
  </script>
</BaseLayout>
